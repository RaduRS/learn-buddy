import { NextResponse } from "next/server";

interface MemoryMatchCard {
  id: string;
  emoji: string;
  isFlipped: boolean;
  isMatched: boolean;
  pairId: string;
}

interface MemoryMatchConfig {
  cards: MemoryMatchCard[];
  gridRows: number;
  gridCols: number;
  numPairs: number;
  timeLimit: number;
}

// Curated list of diverse, kid-friendly emojis
const EMOJI_POOL = [
  // Animals
  "ðŸ¶",
  "ðŸ±",
  "ðŸ­",
  "ðŸ¹",
  "ðŸ°",
  "ðŸ¦Š",
  "ðŸ»",
  "ðŸ¼",
  "ðŸ¨",
  "ðŸ¯",
  "ðŸ¦",
  "ðŸ®",
  "ðŸ·",
  "ðŸ¸",
  "ðŸµ",
  "ðŸ”",
  "ðŸ§",
  "ðŸ¦",
  "ðŸ¤",
  "ðŸ£",
  "ðŸ¦†",
  "ðŸ¦…",
  "ðŸ¦‰",
  "ðŸ¦‡",
  "ðŸº",
  "ðŸ—",
  "ðŸ´",
  "ðŸ¦„",
  "ðŸ",
  "ðŸ›",
  "ðŸ¦‹",
  "ðŸŒ",
  "ðŸž",
  "ðŸœ",
  "ðŸ¦Ÿ",
  "ðŸ¦—",
  "ðŸ•·",
  "ðŸ¦‚",
  "ðŸ¢",
  "ðŸ",
  "ðŸ¦Ž",
  "ðŸ¦–",
  "ðŸ¦•",
  "ðŸ™",
  "ðŸ¦‘",
  "ðŸ¦",
  "ðŸ¦ž",
  "ðŸ¦€",
  "ðŸ¡",
  "ðŸ ",
  "ðŸŸ",
  "ðŸ¬",
  "ðŸ³",
  "ðŸ‹",
  "ðŸ¦ˆ",
  "ðŸŠ",
  "ðŸ…",
  "ðŸ†",
  "ðŸ¦“",
  "ðŸ¦",
  "ðŸ¦§",
  "ðŸ˜",
  "ðŸ¦›",
  "ðŸ¦",
  "ðŸª",
  "ðŸ«",
  "ðŸ¦’",
  "ðŸ¦˜",
  "ðŸƒ",
  "ðŸ‚",
  "ðŸ„",
  "ðŸŽ",
  "ðŸ–",
  "ðŸ",
  "ðŸ‘",
  "ðŸ¦™",
  "ðŸ",
  "ðŸ¦Œ",
  "ðŸ•",
  "ðŸ©",
  "ðŸ¦®",
  "ðŸ•â€ðŸ¦º",
  "ðŸˆ",
  "ðŸ“",
  "ðŸ¦ƒ",
  "ðŸ¦š",
  "ðŸ¦œ",
  "ðŸ¦¢",
  "ðŸ¦©",
  "ðŸ•Š",
  "ðŸ‡",
  "ðŸ¦",
  "ðŸ¦¨",
  "ðŸ¦¡",
  "ðŸ¦¦",
  "ðŸ¦¥",
  "ðŸ",
  "ðŸ€",

  // Food & Drinks
  "ðŸŽ",
  "ðŸŠ",
  "ðŸ‹",
  "ðŸŒ",
  "ðŸ‰",
  "ðŸ‡",
  "ðŸ“",
  "ðŸ«",
  "ðŸˆ",
  "ðŸ’",
  "ðŸ‘",
  "ðŸ¥­",
  "ðŸ",
  "ðŸ¥¥",
  "ðŸ¥",
  "ðŸ…",
  "ðŸ†",
  "ðŸ¥‘",
  "ðŸ¥¦",
  "ðŸ¥¬",
  "ðŸ¥’",
  "ðŸŒ¶",
  "ðŸ«‘",
  "ðŸŒ½",
  "ðŸ¥•",
  "ðŸ«’",
  "ðŸ§„",
  "ðŸ§…",
  "ðŸ¥”",
  "ðŸ ",
  "ðŸ¥",
  "ðŸ¥–",
  "ðŸž",
  "ðŸ¥¨",
  "ðŸ¥¯",
  "ðŸ§€",
  "ðŸ¥š",
  "ðŸ³",
  "ðŸ§ˆ",
  "ðŸ¥ž",
  "ðŸ§‡",
  "ðŸ¥“",
  "ðŸ¥©",
  "ðŸ—",
  "ðŸ–",
  "ðŸ¦´",
  "ðŸŒ­",
  "ðŸ”",
  "ðŸŸ",
  "ðŸ•",
  "ðŸ¥ª",
  "ðŸ¥™",
  "ðŸ§†",
  "ðŸŒ®",
  "ðŸŒ¯",
  "ðŸ«”",
  "ðŸ¥—",
  "ðŸ¥˜",
  "ðŸ«•",
  "ðŸ¥«",
  "ðŸ",
  "ðŸœ",
  "ðŸ²",
  "ðŸ›",
  "ðŸ£",
  "ðŸ±",
  "ðŸ¥Ÿ",
  "ðŸ¦ª",
  "ðŸ¤",
  "ðŸ™",
  "ðŸš",
  "ðŸ˜",
  "ðŸ¥",
  "ðŸ¥ ",
  "ðŸ¥®",
  "ðŸ¢",
  "ðŸ¡",
  "ðŸ§",
  "ðŸ¨",
  "ðŸ¦",
  "ðŸ¥§",
  "ðŸ§",
  "ðŸŽ‚",
  "ðŸ°",
  "ðŸŽ‚",
  "ðŸ®",
  "ðŸ­",
  "ðŸ¬",
  "ðŸ«",
  "ðŸ¿",
  "ðŸ©",
  "ðŸª",
  "ðŸŒ°",
  "ðŸ¥œ",
  "ðŸ¯",

  // Objects & Items
  "âš½",
  "ðŸ€",
  "ðŸˆ",
  "âš¾",
  "ðŸ¥Ž",
  "ðŸŽ¾",
  "ðŸ",
  "ðŸ‰",
  "ðŸ¥",
  "ðŸŽ±",
  "ðŸª€",
  "ðŸ“",
  "ðŸ¸",
  "ðŸ’",
  "ðŸ‘",
  "ðŸ¥",
  "ðŸ",
  "ðŸªƒ",
  "ðŸ¥…",
  "â›³",
  "ðŸª",
  "ðŸ¹",
  "ðŸŽ£",
  "ðŸ¤¿",
  "ðŸ¥Š",
  "ðŸ¥‹",
  "ðŸŽ½",
  "ðŸ›¹",
  "ðŸ›·",
  "â›¸",
  "ðŸ¥Œ",
  "ðŸŽ¿",
  "â›·",
  "ðŸ‚",
  "ðŸª‚",
  "ðŸ‹",
  "ðŸ¤¸",
  "ðŸ¤º",
  "ðŸ¤¾",
  "ðŸŒ",
  "ðŸ‡",
  "ðŸ§˜",
  "ðŸ„",
  "ðŸŠ",
  "ðŸ¤½",
  "ðŸš£",
  "ðŸ§—",
  "ðŸšµ",
  "ðŸš´",
  "ðŸ†",
  "ðŸ¥‡",
  "ðŸ¥ˆ",
  "ðŸ¥‰",
  "ðŸ…",
  "ðŸŽ–",
  "ðŸµ",
  "ðŸŽ—",
  "ðŸŽ«",
  "ðŸŽŸ",
  "ðŸŽª",
  "ðŸ¤¹",
  "ðŸŽ­",
  "ðŸ©°",
  "ðŸŽ¨",
  "ðŸŽ¬",
  "ðŸŽ¤",
  "ðŸŽ§",
  "ðŸŽ¼",
  "ðŸŽµ",
  "ðŸŽ¶",
  "ðŸª˜",
  "ðŸ¥",
  "ðŸª—",
  "ðŸŽ·",
  "ðŸŽº",
  "ðŸª•",
  "ðŸŽ¸",
  "ðŸªˆ",
  "ðŸŽ»",
  "ðŸŽ¹",
  "ðŸª‡",
  "ðŸª©",
  "ðŸ””",
  "ðŸ”•",
  "ðŸŽš",
  "ðŸŽ›",
  "ðŸŽ™",
  "ðŸ“»",
  "ðŸ“±",
  "ðŸ“ž",
  "â˜Ž",
  "ðŸ“Ÿ",
  "ðŸ“ ",
  "ðŸ”‹",
  "ðŸª«",
  "ðŸ”Œ",
  "ðŸ’»",
  "ðŸ–¥",
  "ðŸ–¨",
  "âŒ¨",
  "ðŸ–±",
  "ðŸ–²",
  "ðŸ’½",
  "ðŸ’¾",
  "ðŸ’¿",
  "ðŸ“€",
  "ðŸ§®",
  "ðŸŽ¥",
  "ðŸ“¹",
  "ðŸ“·",
  "ðŸ“¸",
  "ðŸ“¼",
  "ðŸ”",
  "ðŸ”Ž",
  "ðŸ•¯",
  "ðŸ’¡",
  "ðŸ”¦",
  "ðŸ®",
  "ðŸª”",
  "ðŸ“”",
  "ðŸ“•",
  "ðŸ“–",
  "ðŸ“—",
  "ðŸ“˜",
  "ðŸ“™",
  "ðŸ“š",
  "ðŸ““",
  "ðŸ“’",
  "ðŸ“ƒ",
  "ðŸ“œ",
  "ðŸ“„",
  "ðŸ“°",
  "ðŸ—ž",
  "ðŸ“‘",
  "ðŸ”–",
  "ðŸ·",
  "ðŸ’°",
  "ðŸª™",
  "ðŸ’´",
  "ðŸ’µ",
  "ðŸ’¶",
  "ðŸ’·",
  "ðŸ’¸",
  "ðŸ’³",
  "ðŸ§¾",
  "ðŸ’Ž",
  "âš–",
  "ðŸªœ",
  "ðŸ§°",
  "ðŸª›",
  "ðŸ”§",
  "ðŸ”¨",
  "âš’",
  "ðŸ› ",
  "â›",
  "ðŸªš",
  "ðŸ”©",
  "âš™",
  "ðŸª¤",
  "ðŸ§²",
  "ðŸ”«",
  "ðŸ’£",
  "ðŸ§¨",
  "ðŸª“",
  "ðŸ”ª",
  "ðŸ—¡",
  "âš”",
  "ðŸ›¡",
  "ðŸš¬",
  "âš°",
  "ðŸª¦",
  "âš±",
  "ðŸº",
  "ðŸ”®",
  "ðŸ“¿",
  "ðŸ§¿",
  "ðŸ’ˆ",
  "âš—",
  "ðŸ”­",
  "ðŸ”¬",
  "ðŸ•³",
  "ðŸ©¹",
  "ðŸ©º",
  "ðŸ’Š",
  "ðŸ’‰",
  "ðŸ©¸",
  "ðŸ§¬",
  "ðŸ¦ ",
  "ðŸ§«",
  "ðŸ§ª",
  "ðŸŒ¡",
  "ðŸ§¹",
  "ðŸª ",
  "ðŸ§½",
  "ðŸ§´",
  "ðŸ›Ž",
  "ðŸ”‘",
  "ðŸ—",
  "ðŸšª",
  "ðŸª‘",
  "ðŸ›‹",
  "ðŸ›",
  "ðŸ›Œ",
  "ðŸ§¸",
  "ðŸª†",
  "ðŸ–¼",
  "ðŸªž",
  "ðŸªŸ",
  "ðŸ›",
  "ðŸ›’",
  "ðŸŽ",
  "ðŸŽ€",
  "ðŸª„",
  "ðŸª…",
  "ðŸŽŠ",
  "ðŸŽ‰",
  "ðŸŽˆ",
  "ðŸŽ‚",
  "ðŸŽƒ",
  "ðŸŽ„",
  "ðŸŽ‹",
  "ðŸŽ",
  "ðŸŽŽ",
  "ðŸŽ",
  "ðŸŽ",
  "ðŸŽ‘",
  "ðŸ§§",
  "ðŸŽ€",
  "ðŸŽ",
  "ðŸŽ—",
  "ðŸŽŸ",
  "ðŸŽ«",
  "ðŸŽ–",
  "ðŸ†",
  "ðŸ…",
  "ðŸ¥‡",
  "ðŸ¥ˆ",
  "ðŸ¥‰",

  // Nature & Weather
  "â˜€",
  "ðŸŒ¤",
  "â›…",
  "ðŸŒ¦",
  "ðŸŒ§",
  "â›ˆ",
  "ðŸŒ©",
  "ðŸŒ¨",
  "â„",
  "â˜ƒ",
  "â›„",
  "ðŸŒ¬",
  "ðŸ’¨",
  "ðŸŒª",
  "ðŸŒ«",
  "ðŸŒˆ",
  "â˜”",
  "ðŸ’§",
  "ðŸ’¦",
  "ðŸŒŠ",
  "ðŸ”¥",
  "ðŸ’¥",
  "â­",
  "ðŸŒŸ",
  "âœ¨",
  "âš¡",
  "â˜„",
  "ðŸ’«",
  "ðŸŒ™",
  "ðŸŒ›",
  "ðŸŒœ",
  "ðŸŒš",
  "ðŸŒ",
  "ðŸŒž",
  "ðŸª",
  "â­",
  "ðŸŒŸ",
  "âœ¨",
  "ðŸŒ ",
  "ðŸŒŒ",
  "â˜",
  "â›…",
  "â›ˆ",
  "ðŸŒ¤",
  "ðŸŒ¦",
  "ðŸŒ§",
  "ðŸŒ¨",
  "ðŸŒ©",
  "ðŸŒª",
  "ðŸŒ«",
  "ðŸŒ¬",
  "ðŸŒ€",
  "ðŸŒˆ",
  "ðŸŒ‚",
  "â˜‚",
  "â˜”",
  "â›±",
  "âš¡",
  "â„",
  "â˜ƒ",
  "â›„",
  "â˜„",
  "ðŸ”¥",
  "ðŸ’§",
  "ðŸŒŠ",
  "ðŸ’¥",
  "ðŸ’«",
  "ðŸ’¨",
  "ðŸ’¦",
  "ðŸŒ‹",
  "ðŸ”",
  "â›°",
  "ðŸ—»",
  "ðŸ•",
  "ðŸ–",
  "ðŸœ",
  "ðŸ",
  "ðŸž",
  "ðŸŸ",
  "ðŸ›",
  "ðŸ—",
  "ðŸ§±",
  "ðŸª¨",
  "ðŸªµ",
  "ðŸ›–",
  "ðŸ˜",
  "ðŸš",
  "ðŸ ",
  "ðŸ¡",
  "ðŸ¢",
  "ðŸ£",
  "ðŸ¤",
  "ðŸ¥",
  "ðŸ¦",
  "ðŸ§",
  "ðŸ¨",
  "ðŸ©",
  "ðŸª",
  "ðŸ«",
  "ðŸ¬",
  "ðŸ­",
  "ðŸ¯",
  "ðŸ°",
  "ðŸ—¼",
  "ðŸ—½",
  "â›ª",
  "ðŸ•Œ",
  "ðŸ›•",
  "ðŸ•",
  "â›©",
  "ðŸ•‹",
  "â›²",
  "â›º",
  "ðŸŒ",
  "ðŸŒƒ",
  "ðŸ™",
  "ðŸŒ„",
  "ðŸŒ…",
  "ðŸŒ†",
  "ðŸŒ‡",
  "ðŸŒ‰",
  "â™¨",
  "ðŸŽ ",
  "ðŸŽ¡",
  "ðŸŽ¢",
  "ðŸ’ˆ",
  "ðŸŽª",
  "ðŸš‚",
  "ðŸšƒ",
  "ðŸš„",
  "ðŸš…",
  "ðŸš†",
  "ðŸš‡",
  "ðŸšˆ",
  "ðŸš‰",
  "ðŸšŠ",
  "ðŸš",
  "ðŸšž",
  "ðŸš‹",
  "ðŸšŒ",
  "ðŸš",
  "ðŸŽ«",
  "ðŸŽŸ",
  "ðŸšŽ",
  "ðŸš",
  "ðŸš‘",
  "ðŸš’",
  "ðŸš“",
  "ðŸš”",
  "ðŸš•",
  "ðŸš–",
  "ðŸš—",
  "ðŸš˜",
  "ðŸš™",
  "ðŸ›»",
  "ðŸšš",
  "ðŸš›",
  "ðŸšœ",
  "ðŸŽ",
  "ðŸ",
  "ðŸ›µ",
  "ðŸ¦½",
  "ðŸ¦¼",
  "ðŸ›´",
  "ðŸš²",
  "ðŸ›º",
  "ðŸš",
  "ðŸšŸ",
  "ðŸš ",
  "ðŸš¡",
  "ðŸ›°",
  "ðŸš€",
  "ðŸ›¸",
  "ðŸ›¶",
  "â›µ",
  "ðŸš¤",
  "ðŸ›¥",
  "ðŸ›³",
  "â›´",
  "ðŸš¢",
  "âš“",
  "â›½",
  "ðŸš§",
  "ðŸš¨",
  "ðŸš¥",
  "ðŸš¦",
  "ðŸ›‘",
  "ðŸš",
  "â›µ",
  "ðŸ›¶",
  "ðŸš¤",
  "ðŸ›¥",
  "ðŸ›³",
  "â›´",
  "ðŸš¢",

  // Symbols & Shapes
  "â¤",
  "ðŸ§¡",
  "ðŸ’›",
  "ðŸ’š",
  "ðŸ’™",
  "ðŸ’œ",
  "ðŸ–¤",
  "ðŸ¤",
  "ðŸ¤Ž",
  "ðŸ’”",
  "â£",
  "ðŸ’•",
  "ðŸ’ž",
  "ðŸ’“",
  "ðŸ’—",
  "ðŸ’–",
  "ðŸ’˜",
  "ðŸ’",
  "ðŸ’Ÿ",
  "â˜®",
  "âœ",
  "â˜ª",
  "ðŸ•‰",
  "â˜¸",
  "âœ¡",
  "ðŸ”¯",
  "ðŸ•Ž",
  "â˜¯",
  "â˜¦",
  "ðŸ›",
  "â›Ž",
  "â™ˆ",
  "â™‰",
  "â™Š",
  "â™‹",
  "â™Œ",
  "â™",
  "â™Ž",
  "â™",
  "â™",
  "â™‘",
  "â™’",
  "â™“",
  "ðŸ†”",
  "âš›",
  "ðŸ‰‘",
  "â˜¢",
  "â˜£",
  "ðŸ“´",
  "ðŸ“³",
  "ðŸˆ¶",
  "ðŸˆš",
  "ðŸˆ¸",
  "ðŸˆº",
  "ðŸˆ·",
  "âœ´",
  "ðŸ†š",
  "ðŸ’®",
  "ðŸ‰",
  "ãŠ™",
  "ãŠ—",
  "ðŸˆ´",
  "ðŸˆµ",
  "ðŸˆ¹",
  "ðŸˆ²",
  "ðŸ…°",
  "ðŸ…±",
  "ðŸ†Ž",
  "ðŸ†‘",
  "ðŸ…¾",
  "ðŸ†˜",
  "âŒ",
  "â­•",
  "ðŸ›‘",
  "â›”",
  "ðŸ“›",
  "ðŸš«",
  "ðŸ’¯",
  "ðŸ’¢",
  "â™¨",
  "ðŸš·",
  "ðŸš¯",
  "ðŸš³",
  "ðŸš±",
  "ðŸ”ž",
  "ðŸ“µ",
  "ðŸš­",
  "â—",
  "â•",
  "â“",
  "â”",
  "â€¼",
  "â‰",
  "ðŸ”…",
  "ðŸ”†",
  "ã€½",
  "âš ",
  "ðŸš¸",
  "ðŸ”±",
  "âšœ",
  "ðŸ”°",
  "â™»",
  "âœ…",
  "ðŸˆ¯",
  "ðŸ’¹",
  "â‡",
  "âœ³",
  "âŽ",
  "ðŸŒ",
  "ðŸ’ ",
  "â“‚",
  "ðŸŒ€",
  "ðŸ’¤",
  "ðŸ§",
  "ðŸš¾",
  "â™¿",
  "ðŸ…¿",
  "ðŸˆ³",
  "ðŸˆ‚",
  "ðŸ›‚",
  "ðŸ›ƒ",
  "ðŸ›„",
  "ðŸ›…",
  "ðŸš¹",
  "ðŸšº",
  "ðŸš¼",
  "âš§",
  "ðŸš»",
  "ðŸš®",
  "ðŸŽ¦",
  "ðŸ“¶",
  "ðŸˆ",
  "ðŸ”£",
  "â„¹",
  "ðŸ”¤",
  "ðŸ”¡",
  "ðŸ” ",
  "ðŸ†–",
  "ðŸ†—",
  "ðŸ†™",
  "ðŸ†’",
  "ðŸ†•",
  "ðŸ†“",
  "0ï¸âƒ£",
  "1ï¸âƒ£",
  "2ï¸âƒ£",
  "3ï¸âƒ£",
  "4ï¸âƒ£",
  "5ï¸âƒ£",
  "6ï¸âƒ£",
  "7ï¸âƒ£",
  "8ï¸âƒ£",
  "9ï¸âƒ£",
  "ðŸ”Ÿ",
  "ðŸ”¢",
  "#ï¸âƒ£",
  "*ï¸âƒ£",
  "â",
  "â–¶",
  "â¸",
  "â¯",
  "â¹",
  "âº",
  "â­",
  "â®",
  "â©",
  "âª",
  "â«",
  "â¬",
  "â—€",
  "ðŸ”¼",
  "ðŸ”½",
  "âž¡",
  "â¬…",
  "â¬†",
  "â¬‡",
  "â†—",
  "â†˜",
  "â†™",
  "â†–",
  "â†•",
  "â†”",
  "â†ª",
  "â†©",
  "â¤´",
  "â¤µ",
  "ðŸ”€",
  "ðŸ”",
  "ðŸ”‚",
  "ðŸ”„",
  "ðŸ”ƒ",
  "ðŸŽµ",
  "ðŸŽ¶",
  "âž•",
  "âž–",
  "âž—",
  "âœ–",
  "ðŸŸ°",
  "â™¾",
  "ðŸ’²",
  "ðŸ’±",
  "â„¢",
  "Â©",
  "Â®",
  "ã€°",
  "âž°",
  "âž¿",
  "ðŸ”š",
  "ðŸ”™",
  "ðŸ”›",
  "ðŸ”",
  "ðŸ”œ",
  "âœ”",
  "â˜‘",
  "ðŸ”˜",
  "ðŸ”´",
  "ðŸŸ ",
  "ðŸŸ¡",
  "ðŸŸ¢",
  "ðŸ”µ",
  "ðŸŸ£",
  "âš«",
  "âšª",
  "ðŸŸ¤",
  "ðŸ”º",
  "ðŸ”»",
  "ðŸ”¸",
  "ðŸ”¹",
  "ðŸ”¶",
  "ðŸ”·",
  "ðŸ”³",
  "ðŸ”²",
  "â–ª",
  "â–«",
  "â—¾",
  "â—½",
  "â—¼",
  "â—»",
  "ðŸŸ¥",
  "ðŸŸ§",
  "ðŸŸ¨",
  "ðŸŸ©",
  "ðŸŸ¦",
  "ðŸŸª",
  "â¬›",
  "â¬œ",
  "ðŸŸ«",
  "ðŸ”ˆ",
  "ðŸ”‡",
  "ðŸ”‰",
  "ðŸ”Š",
  "ðŸ””",
  "ðŸ”•",
  "ðŸ“£",
  "ðŸ“¢",
  "ðŸ‘â€ðŸ—¨",
  "ðŸ’¬",
  "ðŸ’­",
  "ðŸ—¯",
  "â™ ",
  "â™£",
  "â™¥",
  "â™¦",
  "ðŸƒ",
  "ðŸŽ´",
  "ðŸ€„",
  "ðŸ•",
  "ðŸ•‘",
  "ðŸ•’",
  "ðŸ•“",
  "ðŸ•”",
  "ðŸ••",
  "ðŸ•–",
  "ðŸ•—",
  "ðŸ•˜",
  "ðŸ•™",
  "ðŸ•š",
  "ðŸ•›",
  "ðŸ•œ",
  "ðŸ•",
  "ðŸ•ž",
  "ðŸ•Ÿ",
  "ðŸ• ",
  "ðŸ•¡",
  "ðŸ•¢",
  "ðŸ•£",
  "ðŸ•¤",
  "ðŸ•¥",
  "ðŸ•¦",
  "ðŸ•§",
];

export async function POST(request: Request) {
  try {
    const { rows, cols, pairs } = await request.json();

    // Use provided configuration or fall back to defaults
    const gridRows = rows || 5;
    const gridCols = cols || 5;
    const totalSlots = gridRows * gridCols;
    const numPairs = pairs || Math.floor(totalSlots / 2);

    // Validate that we have enough slots for the pairs
    if (numPairs * 2 > totalSlots) {
      return NextResponse.json(
        {
          error: `Cannot fit ${numPairs} pairs (${numPairs * 2} cards) in a ${gridRows}x${gridCols} grid (${totalSlots} slots)`,
        },
        { status: 400 },
      );
    }

    // Randomly select emojis for this game
    const shuffledEmojis = [...EMOJI_POOL].sort(() => Math.random() - 0.5);
    const selectedEmojis = shuffledEmojis.slice(0, numPairs);

    // Generate cards with emojis
    const cards: MemoryMatchCard[] = [];

    for (let i = 0; i < numPairs; i++) {
      const pairId = `pair-${i}`;
      const emoji = selectedEmojis[i];

      // Create pair of cards
      cards.push(
        {
          id: `${pairId}-1`,
          emoji,
          isFlipped: false,
          isMatched: false,
          pairId,
        },
        {
          id: `${pairId}-2`,
          emoji,
          isFlipped: false,
          isMatched: false,
          pairId,
        },
      );
    }

    // Add empty slots if needed to fill the grid
    const emptySlots = totalSlots - numPairs * 2;
    for (let i = 0; i < emptySlots; i++) {
      cards.push({
        id: `empty-${i}`,
        emoji: "",
        isFlipped: true, // Empty slots are always "flipped" (visible as empty)
        isMatched: true, // Empty slots are always "matched" (can't be clicked)
        pairId: `empty-${i}`,
      });
    }

    // Shuffle cards
    for (let i = cards.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [cards[i], cards[j]] = [cards[j], cards[i]];
    }

    const config: MemoryMatchConfig = {
      cards,
      gridRows,
      gridCols,
      numPairs,
      timeLimit: 300000, // 5 minutes
    };

    return NextResponse.json(config);
  } catch (error) {
    console.error("Memory Match generation error:", error);
    return NextResponse.json(
      { error: "Failed to generate memory match game" },
      { status: 500 },
    );
  }
}
